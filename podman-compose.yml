version: '3.8'

services:
  archiso-builder:
    build:
      context: .
      dockerfile: Dockerfile
    image: prismlinux-archiso:latest
    container_name: archiso-builder
    privileged: true
    security_opt:
      - seccomp=unconfined
    volumes:
      - ./prismlinux:/workspace/prismlinux:Z
      - /etc/pacman.conf:/etc/pacman.conf:ro
      - /etc/pacman.d:/etc/pacman.d:ro
      - /dev:/dev
    working_dir: /workspace
    entrypoint: ["/bin/bash"]
    command:
      - -c
      - |
        echo 'ğŸš€ Starting archiso build...'
        cd /workspace/prismlinux
        rm -rf work out
        
        echo 'âš™ï¸ Running mkarchiso (ignoring container warnings)...'
        mkarchiso -v -w work -o out ./ || {
          echo 'âš ï¸ Build completed with warnings (normal in container)'
          if [ ! -d "out" ] || [ -z "$(ls -A out 2>/dev/null)" ]; then
            echo 'âŒ No output files generated - build failed'
            exit 1
          fi
        }
        
        echo 'âœ… Build completed! ISO is ready.'
        echo 'ğŸ“¦ Listing output files:'
        ls -lh out/
        
        # Check if ISO files exist
        if ls out/*.iso >/dev/null 2>&1; then
          echo 'ğŸ”„ Renaming ISO to PrismLinux with date...'
          for iso in out/*.iso; do
            if [ -f "$iso" ]; then
              date_suffix=$(date +'%m-%Y')
              new_name="out/PrismLinux-$date_suffix.iso"
              mv "$iso" "$new_name"
              echo "ğŸ“ Renamed to: $(basename "$new_name")"
            fi
          done
        else
          echo 'âš ï¸ No ISO files found to rename'
        fi
        
        echo 'ğŸ“¦ Final output:'
        ls -lh out/
        echo 'ğŸ Build finished successfully. Container will now exit.'
    pull_policy: build
    restart: "no"
